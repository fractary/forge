# Best Practices Rules for Claude Code Components
# Version: 2025-12-02 (post-#194)
# Used by: project-auditor agent, project-analyzer skill
#
# These rules define what constitutes "best practices" for Claude Code
# components (commands, agents, skills, hooks). The audit system uses
# these rules to compare actual implementations against expected patterns.

version: "2025-12-02.2"
description: "Best practices rules for Claude Code components - with workflow logging (AGT-005), direct skill command (CMD-004), and director pattern (ARC-004) detection"

# Rule severity levels:
# - critical: Architecture violation, must fix
# - warning: Best practice violation, should fix
# - info: Recommendation, nice to have

rules:
  commands:
    - id: CMD-001
      name: "Command routes to agent"
      description: "Commands must invoke agents, not do work directly"
      severity: critical
      rationale: "Commands are entry points only - all work happens in agents/skills"
      check:
        type: content_pattern
        patterns:
          - "(Agent:|@agent-|invoke.*agent|Task.*agent)"
        must_match: true
      anti_check:
        type: content_pattern
        patterns:
          - "^\\s*(Bash:|Read:|Write:|Edit:|Grep:|Glob:)"
        in_section: "WORKFLOW"
        must_not_match: true
      remediation:
        summary: "Remove direct tool usage, add agent invocation"
        steps:
          - "Identify the agent this command should route to"
          - "Remove any Bash/Read/Write/Edit tool calls from WORKFLOW"
          - "Add agent invocation with structured request"
        example_before: |
          <WORKFLOW>
          1. Run script
             Bash: ./scripts/deploy.sh
          </WORKFLOW>
        example_after: |
          <WORKFLOW>
          1. Invoke deploy-manager agent
             Agent: deploy-manager
             Request: {"operation": "deploy"}
          </WORKFLOW>

    - id: CMD-002
      name: "Proper frontmatter"
      description: "Commands must have name and description in frontmatter"
      severity: warning
      rationale: "Frontmatter enables command discovery and help text"
      check:
        type: frontmatter
        required_fields:
          - name
          - description

    - id: CMD-003
      name: "Space-separated arguments"
      description: "Commands use space-separated argument syntax (--flag value not --flag=value)"
      severity: info
      rationale: "Consistent CLI syntax across all Fractary commands"
      check:
        type: content_pattern
        patterns:
          - "--[a-z-]+\\s+[<\\[]"
        in_section: "ARGUMENT"
        must_match: true

    - id: CMD-004
      name: "No direct skill commands"
      description: "Commands must not invoke skills directly - all workflow operations route through manager agent"
      severity: critical
      rationale: "Direct skill commands bypass centralized logging, orchestration, and state management"
      deprecated_pattern: "Direct skill commands that bypass the manager"
      check:
        type: filename_pattern
        pattern: "*"
        must_not_be: ["*-direct.md", "*director*.md"]  # These are allowed
      anti_check:
        type: content_pattern
        patterns:
          - "Skill\\([\"'](?!.*manager|.*director)"  # Skill call that's not to a manager
          - "@skill-(?!.*manager|.*director)"
        in_section: "WORKFLOW"
        must_not_match: true
        exceptions:
          - "*-direct.md"  # Primary entry points are OK
          - "*director*.md"  # Director skills are OK
      remediation:
        summary: "Route command through manager agent, not direct to skill"
        steps:
          - "Remove direct skill invocation from command"
          - "Create or update manager agent to handle this operation"
          - "Add --action flag support if creating new workflow step"
          - "Update command to invoke manager agent with action parameter"
        example_before: |
          <WORKFLOW>
          1. Invoke validator skill directly
             Skill: myproject-validator
          </WORKFLOW>
        example_after: |
          <WORKFLOW>
          1. Route to manager with validate action
             Agent: myproject-manager
             Request: {"operation": "validate", "target": "..."}
          </WORKFLOW>
        reference: "plugins/faber-agent/docs/BEST-PRACTICES.md#7-direct-skill-commands"

  agents:
    - id: AGT-001
      name: "Single manager per domain"
      description: "Each domain should have one manager agent, not multiple"
      severity: warning
      rationale: "Multiple managers fragment orchestration logic"
      check:
        type: file_count
        pattern: "*-manager.md"
        max_count: 1
        scope: "per_directory"

    - id: AGT-002
      name: "Agent delegates to skills"
      description: "Agents orchestrate but do not do work directly"
      severity: critical
      rationale: "Direct work in agents bloats context and prevents reuse"
      check:
        type: content_pattern
        patterns:
          - "(Skill:|@skill-|invoke.*skill)"
        must_match: true
      anti_check:
        type: content_pattern
        patterns:
          - "^\\s*Bash:"
          - "^\\s*```(bash|sh)"
        in_section: "WORKFLOW"
        must_not_match: true
        exceptions:
          - "scripts/"  # References to scripts are OK
      remediation:
        summary: "Create skills for work, invoke from agent"
        steps:
          - "Identify each piece of work being done directly"
          - "Create a skill for each logical unit of work"
          - "Move Bash/script logic to skill's scripts/ directory"
          - "Update agent to invoke skills instead"

    - id: AGT-003
      name: "Manager uses workflow phases"
      description: "Manager agents should use 7-phase or FABER workflow structure"
      severity: info
      rationale: "Consistent workflow structure aids understanding and debugging"
      check:
        type: content_pattern
        patterns:
          - "(Phase\\s*[1-7]|INSPECT|ANALYZE|PRESENT|APPROVE|EXECUTE|VERIFY|REPORT)"
          - "(Frame|Architect|Build|Evaluate|Release)"
        must_match_any: true

    - id: AGT-004
      name: "Agent not named director"
      description: "Directors should be skills, not agents"
      severity: critical
      rationale: "Directors as skills enables parallel manager invocations"
      check:
        type: filename_pattern
        pattern: "*director*.md"
        must_not_exist_in: "agents/"
      remediation:
        summary: "Move director from agents/ to skills/"
        steps:
          - "Create skill directory: skills/{name}-director/"
          - "Move agent content to skills/{name}-director/SKILL.md"
          - "Remove from agents/ directory"
          - "Update any commands that invoke this agent"

    - id: AGT-005
      name: "Manager emits workflow events"
      description: "Manager agents must emit structured workflow events for cross-project visibility"
      severity: warning
      rationale: "Workflow event logging enables downstream consumption, debugging, and cross-project tracking"
      applies_to:
        - "*-manager.md"
        - "*manager*.md"
      check:
        type: content_pattern
        patterns:
          - "(workflow-event-emitter|emit_workflow_event|emit_event|EVENT_EMISSION)"
          - "(workflow_start|workflow_complete|artifact_create)"
        must_match_any: true
      remediation:
        summary: "Add workflow event emission to manager agent"
        steps:
          - "Add <EVENT_EMISSION> section to manager skill/agent"
          - "Emit workflow_start at workflow initialization"
          - "Emit artifact_create when important outputs created"
          - "Emit workflow_complete at workflow end"
          - "Reference fractary-logs:workflow-event-emitter skill for emission"
        minimum_events:
          - "workflow_start - At workflow initialization"
          - "artifact_create - When important outputs created"
          - "workflow_complete - At workflow end with summary"
        reference: "specs/WORK-00199-automatic-manager-workflow-logging.md"

  skills:
    - id: SKL-001
      name: "Director is skill not agent"
      description: "Director/coordinator components must be skills to enable parallelism"
      severity: critical
      rationale: "Director as skill can spawn parallel manager agents"
      check:
        type: location
        pattern: "*director*"
        must_be_in: "skills/"
        must_not_be_in: "agents/"

    - id: SKL-002
      name: "Scripts externalized"
      description: "Bash logic should be in scripts/ directory, not inline in SKILL.md"
      severity: warning
      rationale: "External scripts are testable, deterministic, and reduce context"
      check:
        type: directory_structure
        requires: "scripts/"
      anti_check:
        type: content_pattern
        patterns:
          - "```(bash|sh)\\n.{100,}```"
        must_not_match: true
      remediation:
        summary: "Move bash code to scripts/*.sh, reference from SKILL.md"
        steps:
          - "Create scripts/ directory in skill folder"
          - "Extract bash code blocks to named .sh files"
          - "Reference scripts in SKILL.md workflow"
          - "Make scripts executable (chmod +x)"

    - id: SKL-003
      name: "Builder updates docs"
      description: "Builder/engineer skills must update documentation as part of workflow"
      severity: warning
      rationale: "Documentation stays current when it's part of the build process"
      applies_to:
        - "*builder*"
        - "*engineer*"
      check:
        type: content_pattern
        patterns:
          - "(fractary-docs|docs-manager|documentation|update.*doc)"
        must_match: true
      remediation:
        summary: "Add documentation update step to builder workflow"
        steps:
          - "Add MANDATORY documentation update rule to CRITICAL_RULES"
          - "Add update-documentation operation"
          - "Invoke fractary-docs:docs-manager after implementation"

    - id: SKL-004
      name: "Skill has proper structure"
      description: "Skills must have SKILL.md with required XML sections"
      severity: warning
      rationale: "Consistent structure aids understanding and maintenance"
      check:
        type: content_pattern
        patterns:
          - "<CONTEXT>"
          - "<CRITICAL_RULES>"
          - "<WORKFLOW>"
        must_match_all: true

    - id: SKL-005
      name: "Debugger maintains knowledge base"
      description: "Debugger skills should maintain troubleshooting knowledge base"
      severity: info
      applies_to:
        - "*debugger*"
      check:
        type: content_pattern
        patterns:
          - "(knowledge.base|KB-|troubleshoot)"
        must_match: true

  architecture:
    - id: ARC-001
      name: "Primary entry point pattern"
      description: "Projects should have /{project}-direct as primary command"
      severity: info
      rationale: "Single entry point simplifies usage and enables --action workflows"
      check:
        type: file_exists
        patterns:
          - "commands/*-direct.md"
          - "commands/*direct*.md"
        must_exist_any: true

    - id: ARC-002
      name: "Action argument support"
      description: "Primary command should support --action for step selection"
      severity: info
      rationale: "Allows running specific workflow steps without full workflow"
      check:
        type: content_pattern
        in_files: "commands/*-direct*.md"
        patterns:
          - "--action"
        must_match: true

    - id: ARC-003
      name: "Plugin integrations"
      description: "Workflows should integrate with Fractary plugins"
      severity: info
      rationale: "Consistent ecosystem integration"
      check:
        type: content_pattern
        patterns:
          - "(fractary-docs|fractary-specs|fractary-logs|fractary-repo)"
        scope: "any_file"
        must_match: true

    - id: ARC-004
      name: "Director multi-step action support"
      description: "Director commands should support comma-separated multi-step actions"
      severity: info
      rationale: "Allows running specific workflow steps: --action frame,architect,build"
      applies_to:
        - "*director*"
        - "*-direct*"
      check:
        type: content_pattern
        patterns:
          - "(comma.separated|comma-separated|multi-step|step1,step2)"
          - "--action.*<.*,.*>"
        must_match_any: true
      remediation:
        summary: "Add multi-step action support to director"
        steps:
          - "Update --action argument to accept comma-separated values"
          - "Document multi-step usage: --action step1,step2,step3"
          - "Parse comma-separated values and execute steps sequentially"
        example: "--action frame,architect,build"

  hooks:
    - id: HK-001
      name: "Hooks in correct location"
      description: "Hooks should be defined in hooks/hooks.json"
      severity: warning
      check:
        type: file_exists
        pattern: "hooks/hooks.json"
        when_hooks_referenced: true

# Scoring configuration
scoring:
  weights:
    critical: 10
    warning: 3
    info: 1

  thresholds:
    excellent: 90
    good: 75
    needs_improvement: 50
    poor: 0

# Report configuration
report:
  include_code_snippets: true
  max_snippet_lines: 20
  group_by: "component"
  show_remediation: true
